<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A-Frame Game</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
</head>
<body>
  <a-scene>
    <!-- Небо и пол -->
    <a-sky color="#87CEEB"></a-sky>
    <a-plane position="0 0 0" rotation="-90 0 0" width="30" height="30" color="#228B22"></a-plane>

    <!-- Эффект взрыва -->
    <a-entity id="explosionEffect" particle-system="preset: explosion; color: yellow; count: 50" visible="false"></a-entity>

    <!-- Звук при сборе -->
    <a-sound id="collectSound" src="yoursound.wav" autoplay="false"></a-sound>

    <!-- Камера с управлением -->
    <a-entity id="player" position="0 1.6 5" movement-controls>
      <a-entity camera look-controls id="cameraEntity">
        <a-entity cursor="fuse: true; fuseTimeout: 500" raycaster="objects: .collectible"></a-entity>
      </a-entity>
      <!-- VR контроллеры -->
      <a-entity laser-controls="hand: right"></a-entity>
      <a-entity laser-controls="hand: left"></a-entity>
    </a-entity>

    <!-- Двигающийся объект -->
    <a-entity id="movingObj" geometry="primitive: cone" material="color: red"
              position="0 2 -8"
              animation="property: position; to: 5 2 -8; dur: 2000; loop: true">
    </a-entity>

    <!-- Коллекционные объекты -->
    <a-entity id="item1" class="collectible" geometry="primitive: box" material="color: blue"></a-entity>
    <a-entity id="item2" class="collectible" geometry="primitive: sphere" material="color: green"></a-entity>
    <a-entity id="item3" class="collectible" geometry="primitive: cylinder" material="color: yellow"></a-entity>

    <!-- Очки и таймер -->
    <a-text id="score" value="Score: 0" position="-1 3 -5" color="#000"></a-text>
    <a-text id="timer" value="Time: 60" position="1 3 -5" color="#000"></a-text>
  </a-scene>

  <script>
    // Движение персонажа
    AFRAME.registerComponent('movement-controls', {
      init: function () {
        this.direction = new THREE.Vector3();
        this.speed = 0.1;
        this.keys = {};
        window.addEventListener('keydown', (e) => this.keys[e.code] = true);
        window.addEventListener('keyup', (e) => this.keys[e.code] = false);
      },
      tick: function () {
        const camera = document.getElementById('cameraEntity'); // Получаем камеру
        camera.object3D.getWorldDirection(this.direction); // Вычисляем направление камеры
        this.direction.y = 0; // Убираем вертикальное движение
        this.direction.normalize(); // Нормализуем вектор

        const currentPos = this.el.object3D.position;

        if (this.keys['KeyW']) currentPos.add(this.direction.multiplyScalar(this.speed));
        if (this.keys['KeyS']) currentPos.add(this.direction.multiplyScalar(-this.speed));

        const right = new THREE.Vector3(0, 0, -1).cross(this.direction).normalize(); // Вычисляем правое направление
        if (this.keys['KeyA']) currentPos.add(right.multiplyScalar(-this.speed));
        if (this.keys['KeyD']) currentPos.add(right.multiplyScalar(this.speed));
      }
    });

    // Спавн объектов
    function spawnObjects() {
      const positions = [];
      for (let i = 0; i < 3; i++) {
        const x = Math.random() * 10 - 5;
        const z = Math.random() * 10 - 5;
        positions.push({x, y: 1, z});
      }
      document.getElementById('item1').setAttribute('position', positions[0]);
      document.getElementById('item2').setAttribute('position', positions[1]);
      document.getElementById('item3').setAttribute('position', positions[2]);
    }

    // Проверка сбора объектов
    AFRAME.registerComponent('collectible', {
      schema: {}, // Добавляем схему для компонента
      init: function () {
        this.collected = false;
      },
      tick: function () {
        const playerPos = document.getElementById('player').object3D.position;
        const itemPos = this.el.object3D.position;
        const distance = playerPos.distanceTo(itemPos);

        if (distance < 1 && !this.collected) {
          this.collected = true;
          this.el.setAttribute('visible', false);

          // Эффекты
          const explosionEffect = document.getElementById('explosionEffect');
          explosionEffect.setAttribute('position', itemPos);
          explosionEffect.setAttribute('visible', true);
          setTimeout(() => explosionEffect.setAttribute('visible', false), 1000); // Скрываем через секунду

          document.getElementById('collectSound').components.sound.playSound();
          score++;
          document.getElementById('score').setAttribute('value', `Score: ${score}`);

          if (score === totalCollectibles) restartGame();
        }
      }
    });

    // Игровые переменные
    let score = 0;
    let time = 60;
    const totalCollectibles = 3;

    // Таймер
    const timer = setInterval(() => {
      if (time-- > 0) {
        document.getElementById('timer').setAttribute('value', `Time: ${time}`);
      } else {
        clearInterval(timer);
        restartGame();
      }
    }, 1000);

    // Перезапуск игры
    function restartGame() {
      score = 0;
      time = 60;
      document.getElementById('score').setAttribute('value', 'Score: 0');
      document.getElementById('timer').setAttribute('value', 'Time: 60');
      document.querySelectorAll('.collectible').forEach(item => {
        item.setAttribute('visible', true);
        item.components.collectible.collected = false;
      });
      spawnObjects();
    }

    // Инициализация
    spawnObjects();
  </script>
</body>
</html>
