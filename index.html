<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A-Frame VR Game for Pico 4</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@6.1.0/dist/aframe-extras.min.js"></script>
</head>
<body>
  <a-scene 
    webxr="requiredFeatures: local-floor; referenceSpaceType: local-floor;"
    xr-mode-ui="enabled: true"
    background="color: #87CEEB"
  >
    <!-- Пол -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="30" height="30" color="#228B22"></a-plane>
    <!-- Игрок и камера -->
    <a-entity id="player" position="0 1.6 5" movement-controls="speed: 0.1" wasd-controls>
      <a-entity camera look-controls>
        <a-entity position="0 0 -1" geometry="primitive: circle; radius: 0.01" 
                 material="color: #FF0000"></a-entity>
        <a-entity cursor="fuse: true; fuseTimeout: 500" 
                 raycaster="objects: .collectible"></a-entity>
      </a-entity>
    </a-entity>
    <!-- VR-контроллеры для Pico 4 -->
    <a-entity id="left-controller"
             laser-controls="hand: left"
             vr-movement="hand: left"
             line="color: #00FF00; opacity: 0.5"></a-entity>
    <a-entity id="right-controller"
             laser-controls="hand: right"
             vr-movement="hand: right"
             line="color: #00FF00; opacity: 0.5"></a-entity>
    <!-- 3D объекты для сбора -->
    <a-entity id="item1" position="0 1 -3" scale="0.5 0.5 0.5" gltf-model="url(sorceress.glb)" class="collectible"></a-entity>
    <a-entity id="item2" position="2 1 -5" scale="0.5 0.5 0.5" gltf-model="url(sorceress.glb)" class="collectible"></a-entity>
    <a-entity id="item3" position="-2 1 -4" scale="0.5 0.5 0.5" gltf-model="url(sorceress.glb)" class="collectible"></a-entity>
    <!-- UI элементы -->
    <a-text id="score" value="Score: 0" position="-1 3 -5" color="#000" scale="2 2 2"></a-text>
    <a-text id="timer" value="Time: 60" position="1 3 -5" color="#000" scale="2 2 2"></a-text>
  </a-scene>
  <script>
    // Инициализация игры
    let score = 0;
    let time = 60;
    const totalCollectibles = 3;

    // Компонент для движения через контроллеры
    AFRAME.registerComponent('vr-movement', {
      schema: { hand: { type: 'string' } },
      init: function () {
        this.move = this.move.bind(this);
        this.el.addEventListener('triggerdown', this.move);
        this.el.addEventListener('axismove', (event) => this.handleAxisMove(event));
      },
      move: function () {
        const player = document.getElementById('player');
        const direction = new THREE.Vector3();
        this.el.object3D.getWorldDirection(direction);
        direction.y = 0;
        direction.normalize();

        const speed = 0.3;
        const position = player.getAttribute('position');
        position.x += direction.x * speed;
        position.z += direction.z * speed;
        player.setAttribute('position', position);
      },
      handleAxisMove: function (event) {
        const player = document.getElementById('player');
        const axis = event.detail.axis;
        if (!axis) return;

        const speed = 0.1;
        const position = player.getAttribute('position');

        // Движение вперед/назад по оси Y джойстика
        if (Math.abs(axis[1]) > 0.1) {
          const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(player.object3D.quaternion);
          position.x += forward.x * axis[1] * speed;
          position.z += forward.z * axis[1] * speed;
        }

        // Поворот влево/вправо по оси X джойстика
        if (Math.abs(axis[0]) > 0.1) {
          const rotation = player.getAttribute('rotation');
          rotation.y += axis[0] * 2; // Скорость поворота
          player.setAttribute('rotation', rotation);
        }

        player.setAttribute('position', position);
      }
    });

    // Система сбора объектов
    AFRAME.registerComponent('collectible', {
      init: function () {
        this.el.classList.add('collectible');
        this.collected = false;
        this.el.addEventListener('click', () => this.collect());
      },
      collect: function () {
        if (this.collected) return;

        this.el.setAttribute('visible', false);
        this.collected = true;
        score++;
        document.getElementById('score').setAttribute('value', `Score: ${score}`);

        if (score === totalCollectibles) restartGame();
      }
    });

    // Система коллизий
    AFRAME.registerComponent('collision-check', {
      tick: function () {
        const player = this.el;
        document.querySelectorAll('.collectible').forEach(item => {
          const distance = player.object3D.position.distanceTo(item.object3D.position);
          if (distance < 1 && !item.collected) {
            item.components.collectible.collect();
          }
        });
      }
    });

    // Таймер игры
    const timerInterval = setInterval(() => {
      if (time <= 0) {
        clearInterval(timerInterval);
        restartGame();
        return;
      }
      time--;
      document.getElementById('timer').setAttribute('value', `Time: ${time}`);
    }, 1000);

    // Перезапуск игры
    function restartGame() {
      score = 0;
      time = 60;

      document.querySelectorAll('.collectible').forEach(item => {
        item.setAttribute('visible', true);
        item.collected = false;
      });
      document.getElementById('player').setAttribute('position', '0 1.6 5');
      document.getElementById('score').setAttribute('value', 'Score: 0');
      document.getElementById('timer').setAttribute('value', 'Time: 60');
    }

    // Инициализация компонентов
    document.getElementById('player').setAttribute('collision-check', '');
  </script>
</body>
</html>
